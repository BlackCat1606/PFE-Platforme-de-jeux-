{% extends "user/_page-dashboard.html" %}
{% import "event/_macros-event.html" as eventMacros %}
{% import "_macros-form.html" as formMacros %}

{% block styles %}
<style type="text/css">
#js-importer .select2-results__option {
  font-size: 30px;
}
</style>
{% endblock %}

{% block dashboardBody %}

<h1>Importateur de soumissions externes</h1>

<div class="action-banner">
  <p>Cet outil vous aide à importer des soumissions à partir d'autres sites Web. Si vous ne trouvez pas le site que vous recherchez, vous pouvez toujours utiliser le formulaire manuel.</p>
  <a href="/external-entry/create-entry" class="btn btn-default">Créer une soumission manuellement</a>
  <a href="{{ buildUrl(user, 'user', 'entries') }}" class="btn btn-default">Retour à Soumissions</a>
</div>

<form method="post">
  {{ csrfToken() | safe }}
  <div class="horizontal-bar">Configuration de l'importateur</div>
  <div class="row">
    <div class="col-md-6">
      <div class="form-group">
        <label for="title">Importateur</label>
        <select class="form-control js-importer" id="js-importer" name="importer" required="required">
          <option {{ 'selected' if not importer }}></option>
          {% for availableImporter in availableImporters %}
            <option value="{{ availableImporter.config.id }}"
              data-mode="{{ availableImporter.config.mode }}" 
              data-oauth-url="{{ availableImporter.config.oauthUrl }}" 
              {{ 'selected' if importer === availableImporter.config.id }}>
                {{ availableImporter.config.title }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group" id="js-profile" style="display: none">
        <label for="title">Nom d'utilisateur ou URL du profil</label>
        <input class="form-control" id="profileIdentifier" name="profileIdentifier" type="text" value="{{ profileIdentifier }}" />
      </div>
      <div class="form-group" id="js-oauth" style="display: none">
        <label for="title">Clé OAuth</label>
        <ol style="padding-left: 20px; font-size: 1.1rem; line-height: 3rem">
          <li>
            <a id="js-oauth-button" href="?" class="btn btn-primary" target="_blank">
              <span class="fas fa-external-link"></span> <span id="js-oauth-label"></span>
            </a>
          </li>
          <li>
            <input class="form-control" id="oauthIdentifier" name="oauthIdentifier" type="text" value="{{ oauthIdentifier }}" placeholder="Paste the key here" />
          </li>
        </ol>
        <p>Remarque: la clé d'authentification ne sera pas enregistrée. Il ne sera utilisé que pour importer des jeux, puis oublié.</p>
      </div>
    </div>
  </div>
  <div id="js-entry-references">
  {% if entryReferences %}
    <div class="horizontal-bar">Soumissions trouvées</div>
    <div class="row">
      <div class="col-md-9">
        <div class="form-group">

          {% if entryReferences.error %}
            <p><b>Erreur:</b> {{ entryReferences.error }}.</p>
            <p>Si vous êtes sûr que le site Web cible est en ligne, il y a peut-être un bogue, voir <a href="/article/docs">les docs pour savoir comment contacter un administrateur</a>.</p>
          {% elseif entryReferences.length > 0 %}

            <p>Veuillez cocher les jeux que vous souhaitez importer.</p>
            <p>
              <input type="button" class="btn btn-default btn-sm js-check-all" value="Cocher tout"
                     data-check-all-selector=".js-import-checkbox"/>
              <input type="button" class="btn btn-default btn-sm js-check-none" value="Décocher tout"
                     data-check-none-selector=".js-import-checkbox"/>
            </p>
            <table class="table">
              <thead>
                <th>
                  Importer?
                </th>
                <th></th>
                <th>Titre</th>
                <th>Déja importé</th>
              </thead>
              <tbody>
              {% for entryReference in entryReferences %}
                <tr>
                  <td>
                    <input type="checkbox" name="entries" value="{{ entryReference.id }}" class="js-checkbox js-import-checkbox" />
                  </td>
                  <td>
                    {% if entryReference.thumbnail %}
                      <img src="{{ entryReference.thumbnail }}" style="max-width: 200px; max-height: 150px" />
                    {% endif %}
                  </td>
                  <td>
                    <h3>
                    {% if entryReference.link %}
                      <a target="_blank" href="{{ entryReference.link }}">{{ entryReference.title }} <span class="legend fas fa-external-link"></span></a>
                    {% else %}
                      {{ entryReference.title }}
                    {% endif %}
                    </h3>
                  </td>
                  <td>
                    {% if entryReference.existingEntry %}
                      <p><span class="label label-warning">Oui, la soumission sera mise à jour</span></p>
                      {{ eventMacros.entrySmallThumb(entryReference.existingEntry) }}
                    {% else %}
                      <span class="label label-default">Non</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>

            <div class="form-group well">
              <label>
                <input type="checkbox" name="run" class="form-control js-checkbox" />
                &nbsp;Je confirme que ces jeux sont les miens. Si je change d’avis, je devrai les supprimer un à un. Importons-les!
              </label>
            </div>

          {% else %}
            <p>Aucune soumission n'a été trouvée pour ce nom d'utilisateur.</p>
          {% endif %}
        </div>
      </div>
    </div>
  {% endif %}
  </div>

  <div class="form-group">
    <input type="submit" value="Confirmer" class="btn btn-primary" />
  </div>
</form>

{% endblock %}
